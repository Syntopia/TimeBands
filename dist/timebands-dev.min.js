var TextBoxStyle=function(){this.rx=0,this.ry=0,this.strokeWidth=.2,this.textStroke="#000",this.textStrokeWidth=0,this.opacity=1,this.bgfill="white",this.textFill="#000",this.fontSize=18,this.section=!1},Viewport=function(t){this.zoom=1,this.centerX=0,this.svg=t,this.scalableElements=[];var e=this;this.svg.addEventListener("wheel",function(t){e.mouseWheel(t)},!1),this.svg.addEventListener("mousedown",function(t){e.mouseDown(t)},!1),this.svg.addEventListener("mouseup",function(t){e.mouseUp(t)},!1),this.svg.addEventListener("mousemove",function(t){e.mouseMove(t)},!1)};Viewport.prototype.mouseUp=function(t){this.dragging=!1},Viewport.prototype.mouseMove=function(t){if(this.dragging){var e=svg.getBoundingClientRect(),i=t.clientX-e.left;t.clientY-e.top;this.centerX=this.centerXDown+2*(i-this.mouseDownX)/this.zoom,this.redraw(!1,t)}},Viewport.prototype.mouseDown=function(t){var e=svg.getBoundingClientRect();this.mouseDownX=t.clientX-e.left,this.mouseDownY=t.clientY-e.top,this.centerXDown=this.centerX,this.dragging=!0,this.dirty=!0};var ScaleInfo=function(t,e){this.textWidth=t,this.rectWidth=e,this.getRatio=function(){return e/t}};Viewport.prototype.redraw=function(t,e){var i=svg.getElementById("svgtop"),n="matrix(sx 0 0 1 tx 0)".replace("sx",this.zoom).replace("tx",this.centerX*this.zoom);i.setAttribute("transform",n);var s=svg.getBoundingClientRect(),o=e.clientX-s.left;svg.getBoundingClientRect().width,o*this.zoom,-this.centerX;if(t){if(void 0===this.scaleMap){this.scaleMap=new Map;for(var r=0;r<this.scalableElements.length;r++){var a=this.scalableElements[r].childNodes[0],d=this.scalableElements[r].childNodes[1],l=d.getBBox().width+5,h=a.getBBox().width;this.scaleMap.set(this.scalableElements[r],new ScaleInfo(l,h))}}for(var r=0;r<this.scalableElements.length;r++){var a=this.scalableElements[r].childNodes[0],d=this.scalableElements[r].childNodes[1];d.setAttribute("transform","scale("+1/this.zoom+",1)");var c=this.scaleMap.get(this.scalableElements[r]),u=c.getRatio()*this.zoom,m=1;c.rectWidth*this.zoom<5?a.setAttribute("visibility","hidden"):a.setAttribute("visibility","visibility"),.3>u?d.setAttribute("visibility","hidden"):(d.setAttribute("visibility","visibility"),1>u?(d.setAttribute("transform","scale("+u/this.zoom+",1)"),d.setAttribute("x",0)):d.setAttribute("x",c.rectWidth*this.zoom/2-c.textWidth/2)),d.setAttribute("opacity",m)}}},Viewport.prototype.mouseWheel=function(t){var e=1;e=t.deltaY>0?1.4:1/1.4,t.preventDefault();var i=svg.getBoundingClientRect(),n=t.clientX-i.left,s=(svg.getBoundingClientRect().width,n/this.zoom),o=-this.centerX;this.zoom*=e;var r=n/this.zoom;return this.centerX+=r-s,o=-this.centerX,this.redraw(!0,t),!1};var Band=function(t,e,i){if(void 0!==e?this.height=e:this.height=t.defaultBandHeight,this.yOffset=0,this.infos={},this.timeBand=t,t.addBand(this),void 0!==i){var n=new TextBoxStyle;n.opacity=.8,n.strokeWidth=.5,n.bgfill="#fff",n.fontSize=20,n.textStroke="#fff",n.textStrokeWidth=0,n.textFill="#000",n.rx=5,n.ry=5;var s=this.timeBand.svg.getElementById("svgbottom"),o=this.add(0,8,i,n,void 0,s),r=o.childNodes[0],a=o.childNodes[1],d=a.getBBox().width+5;r.setAttribute("width",d+5)}};Band.prototype={constructor:Band,init:function(t){this.addListeners(t)},add:function(t,e,i,n,s,o){void 0===o&&(o=this.timeBand.top);var r=this.yOffset,a=this.height;n.section&&(r-=this.yOffset,a+=this.yOffset);var d=timebands.addBox(o,this.timeBand.cellWidth*t,r,this.timeBand.cellWidth*(e-t),a,i,n,s);this.infos[d]=" Text: "+i,o===this.timeBand.top&&this.timeBand.scalableElements.push(d);var l=this;return d.addEventListener("click",function(t){l.boxClicked(d)}),n.section||(d.addEventListener("mouseover",function(t){l.boxMouseover(d)}),d.addEventListener("mouseout",function(t){l.boxMouseout(d)})),d},boxClicked:function(t){console.log("Clicked: ",this.infos[t])},boxMouseover:function(t){var e=t.childNodes[0];t.childNodes[1];e.style.stroke="red",e.style.strokeWidth="2"},boxMouseout:function(t){var e=t.childNodes[0];t.childNodes[1];e.style.stroke=e.style.originalStroke,e.style.stroke="black",e.style.strokeWidth="0.2"}};var TimeBand=function(t,e,i,n){this.view=new Viewport(t);var s=document.createElementNS("http://www.w3.org/2000/svg","defs"),o=timebands.createLinearGradient("grad1","0%","30%","0%","100%");o.appendChild(timebands.createStop("0%","stop-color:rgb(255,255,255);stop-opacity:1")),o.appendChild(timebands.createStop("100%","stop-color:rgb(240,224,195);stop-opacity:1"));var r=timebands.createLinearGradient("grad3","0%","30%","0%","100%");r.appendChild(timebands.createStop("0%","stop-color:rgb(245,245,235);stop-opacity:1")),r.appendChild(timebands.createStop("100%","stop-color:rgb(225,225,225);stop-opacity:1"));var a=timebands.createLinearGradient("grad2","0%","30%","0%","100%");a.appendChild(timebands.createStop("0%","stop-color:rgb(255,255,255);stop-opacity:1")),a.appendChild(timebands.createStop("100%","stop-color:rgb(192,208,163);stop-opacity:1")),s.appendChild(o),s.appendChild(r),s.appendChild(a),t.appendChild(s);var d=document.createElementNS("http://www.w3.org/2000/svg","g");d.setAttribute("id","svgtop");var l=document.createElementNS("http://www.w3.org/2000/svg","g");l.setAttribute("id","svgbottom"),t.appendChild(d),t.appendChild(l),this.startYear=e,this.scalableElements=[],this.numberOfDays=n,this.startMonth=i,this.defaultBandHeight=20,this.svg=t,this.cellWidth=20,this.top=t.getElementById("svgtop"),this.nextYOffset=0,this.bands=[]};TimeBand.monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],TimeBand.monthColors2=["#FC9","#FEC","#FC9","#CDA","#EED","#CDA","#FC9","#FEC","#FC9","#CDA","#EED","#CDA"],TimeBand.monthColors=["#EEE","#FFF","#EEE","#FFF","#EEE","#FFF","#EEE","#FFF","#EEE","#FFF","#EEE","#FFF"],TimeBand.prototype={constructor:TimeBand,addBand:function(t){this.bands.push(t),t.yOffset=this.nextYOffset,this.nextYOffset+=t.height,console.log("Added band "+t+". Current offset: "+this.nextYOffset)},addHeader:function(){var t=new TextBoxStyle,e=this,i=[],n=[],s=[],o=-1,r=-1,a=new Band(e,13);t.fontSize=10;for(var d=0;d<this.numberOfDays;d++){var l=new Date(e.startYear,e.startMonth,d+1);l.getMonth()!=o&&(i.push(d),o=l.getMonth());var h=l.getWeekNumber();h!=r&&(n.push(d),s.push(h),r=h),a.add(d,d+1,l.getDate(),t,l+"")}i.push(this.numberOfDays),t.fontSize=18;for(var c=new Band(e),u=0;u<n.length-1;u++)t.bgfill=u%2==1?"none":"#eee",t.textFill="#fff",console.log("Week "+u+" from "+n[u]+" to: "+n[u+1]),c.add(n[u],n[u+1],s[u],t);for(var m=new Band(e),u=0;u<i.length-1;u++){var d=i[u],f=i[u+1],l=new Date(e.startYear,e.startMonth,d+1);t.bgfill=TimeBand.monthColors[l.getMonth()],m.add(d,f,TimeBand.monthNames[l.getMonth()],t)}}};var timebands={REVISION:"0.0.1"};timebands.dateDiffInDays=function(t,e){var i=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()),n=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());return Math.floor((n-i)/864e5)},Date.prototype.getWeekNumber=function(){var t=new Date(+this);return t.setHours(0,0,0),t.setDate(t.getDate()+4-(t.getDay()||7)),Math.ceil(((t-new Date(t.getFullYear(),0,1))/864e5+1)/7)},timebands.createLinearGradient=function(t,e,i,n,s){var o=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");return o.setAttribute("id",t),o.setAttribute("x1",e),o.setAttribute("y1",i),o.setAttribute("x2",n),o.setAttribute("y2",s),o},timebands.createStop=function(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg","stop");return i.setAttribute("offset",t),i.setAttribute("style",e),i},timebands.addBox=function(t,e,i,n,s,o,r,a){var d=document.createElementNS("http://www.w3.org/2000/svg","g");d.setAttribute("transform","translate("+e+","+i+")");var l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.style.fill=r.bgfill,l.style.stroke="black",l.style.originalStroke=l.style.stroke,l.setAttribute("x",0),l.setAttribute("y",0),l.setAttribute("width",n),l.setAttribute("height",s),l.setAttribute("rx",r.rx),l.setAttribute("ry",r.ry),l.style.strokeWidth=r.strokeWidth,l.style.originalStrokeWidth=l.style.strokeWidth,l.style.opacity=r.opacity;var h=document.createElementNS("http://www.w3.org/2000/svg","text");if(h.setAttribute("x",5),h.setAttribute("transform","scale(1,1)"),h.style.fontfamily="Helvetica",h.setAttribute("y",s-3),h.setAttribute("font-size",r.fontSize),d.setAttribute("alignment-baseline","baseline"),h.textContent=o,d.appendChild(l),d.appendChild(h),void 0!==a){var c=document.createElementNS("http://www.w3.org/2000/svg","title");c.textContent=a,d.appendChild(c)}return t.hasChildNodes()&&void 0!==t.children?t.insertBefore(d,t.children[0]):t.appendChild(d),d},timebands.init=function(t,e,i,n,s){var o=new Date(i,n-1,1);t.setAttribute("style","font-family: Helvetica, Arial;-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;");var r=new TimeBand(t,i,n-1,s);r.addHeader();var a=7,d=30,l=new TextBoxStyle;l.fontSize=20,l.rx=3,l.ry=3,l.bgfill="url(#grad3)";var h=new TimeBandsParser;h.parse(e.innerHTML);for(var c=0;c<h.bandSections.length;c++){var u=h.bandSections[c];new Band(r,a),u.name.startsWith("!")?(l.section=!0,b=new Band(r,d,u.name.substr(1))):b=new Band(r,d,u.name);for(var m=0;m<u.entries.length;m++){l.section&&(l.bgfill=m%2==0?"url(#grad1)":"url(#grad2)");var f=u.entries[m],g=f.getIntervalRelativeToDate(o);b.add(g[0],g[1]+1,f.name,l)}}r.view.scalableElements=r.scalableElements},timebands.create=function(t,e,i,n,s){svg=document.getElementById(t),defs=document.getElementById(e),timebands.init(svg,defs,i,n,s),svg.addEventListener("load",function(){timebands.init(svg,defs,i,n,s)},!1)};var BandEntry=function(t,e,i){this.name=t,this.from=e,this.to=i,this.getIntervalRelativeToDate=function(t){var n=timebands.dateDiffInDays(t,e),s=timebands.dateDiffInDays(t,i);return[n,s]}},BandSection=function(t){this.name=t,this.entries=[],this.toString=function(){return"BandSection["+t+"]: "+this.entries.length+" + entries"},this.addEntry=function(t){console.log("Added entry: "+t),this.entries.push(t)}},TimeParser=function(t){this.implicitYear=t};TimeParser.prototype={parseInterval:function(t){var e=t.split("-");if(2!=e.length)throw"The date interval ["+t+"] did not contain exactly one hyphen";var i=this.parseTime(e[0]),n=this.parseTime(e[1]);return[i,n]},parseTime:function(t){t=t.trim();var e,i=t.split("/");if(2==i.length)e=new Date(this.implicitYear,i[1]-1,i[0]);else{if(3!=i.length)throw"The date ["+t+"] did not contain one or two /-es";var n=i[2];100>n&&(n+=2e3),e=new Date(n,i[1]-1,i[0])}return console.log("Parsed date: "+e),e}};var TimeBandsParser=function(){this.bandSections=[],this.timeParser=new TimeParser(2015)};TimeBandsParser.prototype={addBandSection:function(t){void 0!==t&&(this.bandSections.push(t),console.log("New section:"+t.toString()))},parseEntry:function(t){var e=t.split(":");if(2!=e.length)throw"The entry ["+t+"] did not contain exactly one colon";var i=this.timeParser.parseInterval(e[0]),n=e[1],s=new BandEntry(n,i[0],i[1]);return s},parse:function(t){for(var e=t.match(/[^\r\n]+/g),i=void 0,n=0;n<e.length;n++)if(n<e.length-1&&e[n+1].startsWith("---"))i=new BandSection(e[n]),this.addBandSection(i),n++;else{if(console.log(n+" "+e[n]),void 0===i)throw"When parsing ["+e[n]+"] no section was defined";var s=this.parseEntry(e[n]);i.addEntry(s)}}};
//# sourceMappingURL=timebands-dev.min.js.map