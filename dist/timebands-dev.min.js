var TextBoxStyle=function(){this.rx=0,this.ry=0,this.strokeWidth=.2,this.textStroke="#000",this.textStrokeWidth=0,this.opacity=1,this.bgfill="white",this.textFill="#000",this.fontSize=18,this.section=!1},Viewport=function(t){this.zoom=1,this.centerX=0,this.svg=t,this.scalableElements=[];var e=this;this.svg.addEventListener("wheel",function(t){e.mouseWheel(t)},!1),this.svg.addEventListener("mousedown",function(t){e.mouseDown(t)},!1),this.svg.addEventListener("mouseup",function(t){e.mouseUp(t)},!1),this.svg.addEventListener("mousemove",function(t){e.mouseMove(t)},!1)};Viewport.prototype.mouseUp=function(t){this.dragging=!1},Viewport.prototype.mouseMove=function(t){if(this.dragging){var e=svg.getBoundingClientRect(),i=t.clientX-e.left;t.clientY-e.top;this.centerX=this.centerXDown+2*(i-this.mouseDownX)/this.zoom,this.redraw(!1,t)}},Viewport.prototype.mouseDown=function(t){var e=svg.getBoundingClientRect();this.mouseDownX=t.clientX-e.left,this.mouseDownY=t.clientY-e.top,this.centerXDown=this.centerX,this.dragging=!0,this.dirty=!0};var ScaleInfo=function(t,e,i,n,s){this.textWidth=t,this.rectWidth=e,this.textHeight=i,this.rectHeight=n,this.uniformScale=s,this.getRatio=function(){return e/t},this.getHeightRatio=function(){return n/i}};Viewport.prototype.redraw=function(t,e){var i=svg.getElementById("svgtop"),n="matrix(sx 0 0 1 tx 0)".replace("sx",this.zoom).replace("tx",this.centerX*this.zoom);i.setAttribute("transform",n);var s=svg.getBoundingClientRect(),a=e.clientX-s.left;svg.getBoundingClientRect().width,a*this.zoom,-this.centerX;if(t){if(void 0===this.scaleMap){this.scaleMap=new Map;for(var o=0;o<this.scalableElements.length;o++){var r=this.scalableElements[o].childNodes[0],d=this.scalableElements[o].childNodes[1],h=d.getBBox().width+5,l=r.getBBox().width,c=d.getBBox().height-10,u=r.getBBox().height;this.scalableElements[o].uniformScale&&(console.log(h),h=this.scalableElements[o].uniformScale),this.scaleMap.set(this.scalableElements[o],new ScaleInfo(h,l,c,u,this.scalableElements[o].uniformScale))}}for(var o=0;o<this.scalableElements.length;o++){var r=this.scalableElements[o].childNodes[0],d=this.scalableElements[o].childNodes[1];d.setAttribute("transform","scale("+1/this.zoom+",1)");var f=this.scaleMap.get(this.scalableElements[o]),g=f.getRatio()*this.zoom,m=1;f.rectWidth*this.zoom<5?r.setAttribute("visibility","hidden"):r.setAttribute("visibility","visible"),.1>g?d.setAttribute("visibility","hidden"):(d.setAttribute("visibility","visible"),1>g?f.uniformScale?(d.setAttribute("visibility","hidden"),r.setAttribute("visibility","hidden")):(d.setAttribute("transform","scale("+g/this.zoom+","+g+")"),d.setAttribute("x",0),d.setAttribute("y",1/g*2*f.rectHeight/2-f.textHeight/2)):(d.setAttribute("x",f.rectWidth*this.zoom/2-f.textWidth/2),d.setAttribute("y",2*f.rectHeight/2-f.textHeight/2))),d.setAttribute("opacity",m)}}},Viewport.prototype.mouseWheel=function(t){var e=1;e=t.deltaY>0?1.2:1/1.2,t.preventDefault();var i=svg.getBoundingClientRect(),n=t.clientX-i.left,s=(svg.getBoundingClientRect().width,n/this.zoom),a=-this.centerX;this.zoom*=e;var o=n/this.zoom;return this.centerX+=o-s,a=-this.centerX,this.redraw(!0,t),!1};var Band=function(t,e,i){if(void 0!==e?this.height=e:this.height=t.defaultBandHeight,this.yOffset=0,this.infos={},this.timeBand=t,t.addBand(this),void 0!==i){var n=new TextBoxStyle;n.opacity=1,n.strokeWidth=.5,n.bgfill="#fff",n.fontSize=20,n.textStroke="#fff",n.textStrokeWidth=0,n.textFill="#000",n.rx=5,n.ry=5;var s=this.timeBand.svg.getElementById("svgbottom"),a=this.add(0,8,i,n,void 0,s),o=a.childNodes[0],r=a.childNodes[1],d=r.getBBox().width+5;o.setAttribute("width",d+5)}};Band.prototype={constructor:Band,init:function(t){this.addListeners(t)},add:function(t,e,i,n,s,a){void 0===a&&(a=this.timeBand.top);var o=this.yOffset,r=this.height;n.section&&(o-=this.yOffset-this.timeBand.headerHeight,r+=this.yOffset-this.timeBand.headerHeight);var d=timebands.addBox(a,this.timeBand.cellWidth*t,o,this.timeBand.cellWidth*(e-t),r,i,n,s);this.infos[d]=" Text: "+i,a===this.timeBand.top&&(this.uniformScale&&(d.uniformScale=this.uniformScale),this.timeBand.scalableElements.push(d));var h=this;return d.addEventListener("click",function(t){h.boxClicked(d)}),n.section||(d.addEventListener("mouseover",function(t){h.boxMouseover(d)}),d.addEventListener("mouseout",function(t){h.boxMouseout(d)})),d},boxClicked:function(t){console.log("Clicked: ",this.infos[t])},boxMouseover:function(t){var e=t.childNodes[0];t.childNodes[1];e.style.stroke="red",e.style.strokeWidth="2"},boxMouseout:function(t){var e=t.childNodes[0];t.childNodes[1];e.style.stroke=e.style.originalStroke,e.style.stroke="black",e.style.strokeWidth="0.2"}};var TimeBand=function(t,e,i,n){this.view=new Viewport(t);var s=document.createElementNS("http://www.w3.org/2000/svg","defs"),a=timebands.createLinearGradient("grad1","0%","30%","0%","100%");a.appendChild(timebands.createStop("0%","stop-color:rgb(240,224,195);stop-opacity:0.5")),a.appendChild(timebands.createStop("100%","stop-color:rgb(240,224,195);stop-opacity:0.5"));var o=timebands.createLinearGradient("grad3","0%","30%","0%","100%");o.appendChild(timebands.createStop("0%","stop-color:rgb(255,255,255);stop-opacity:0.5")),o.appendChild(timebands.createStop("100%","stop-color:rgb(225,225,225);stop-opacity:0.5"));var r=timebands.createLinearGradient("grad2","0%","30%","0%","100%");r.appendChild(timebands.createStop("0%","stop-color:rgb(192,208,163);stop-opacity:1")),r.appendChild(timebands.createStop("100%","stop-color:rgb(192,208,163);stop-opacity:1")),s.appendChild(a),s.appendChild(o),s.appendChild(r),t.appendChild(s);var d=document.createElementNS("http://www.w3.org/2000/svg","g");d.setAttribute("id","svgtop");var h=document.createElementNS("http://www.w3.org/2000/svg","g");h.setAttribute("id","svgbottom"),t.appendChild(d),t.appendChild(h),this.startYear=e,this.scalableElements=[],this.numberOfDays=n,this.startMonth=i,this.defaultBandHeight=20,this.svg=t,this.cellWidth=20,this.top=t.getElementById("svgtop"),this.nextYOffset=0,this.bands=[]};TimeBand.monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],TimeBand.monthColors2=["#FC9","#FEC","#FC9","#CDA","#EED","#CDA","#FC9","#FEC","#FC9","#CDA","#EED","#CDA"],TimeBand.monthColors=["#EEE","#FFF","#EEE","#FFF","#EEE","#FFF","#EEE","#FFF","#EEE","#FFF","#EEE","#FFF"],TimeBand.prototype={constructor:TimeBand,addBand:function(t){this.bands.push(t),t.yOffset=this.nextYOffset,this.nextYOffset+=t.height,console.log("Added band "+t+". Current offset: "+this.nextYOffset)},addHeader:function(){var t=new TextBoxStyle,e=this,i=[],n=[],s=[],a=-1,o=-1,r=new Band(e,13);r.uniformScale=16,t.fontSize=10;for(var d=0;d<this.numberOfDays;d++){var h=new Date(e.startYear,e.startMonth,d+1);h.getMonth()!=a&&(i.push(d),a=h.getMonth());var l=h.getWeekNumber();l!=o&&(n.push(d),s.push(l),o=l),r.add(d,d+1,h.getDate(),t,h+"")}i.push(this.numberOfDays),t.fontSize=18;var c=new Band(e);c.uniformScale=25;for(var u=0;u<n.length-1;u++)t.bgfill=u%2==1?"none":"#eee",t.textFill="#fff",console.log("Week "+u+" from "+n[u]+" to: "+n[u+1]),c.add(n[u],n[u+1],s[u],t);var f=new Band(e);f.uniformScale=37;for(var u=0;u<i.length-1;u++){var d=i[u],g=i[u+1],h=new Date(e.startYear,e.startMonth,d+1);t.bgfill=TimeBand.monthColors[h.getMonth()],f.add(d,g,TimeBand.monthNames[h.getMonth()],t)}this.headerHeight=this.nextYOffset},addOverlay:function(){var t=new TextBoxStyle,e=this,i=[],n=-1;t.fontSize=10;for(var s=0;s<this.numberOfDays;s++){var a=new Date(e.startYear,e.startMonth,s+1),o=a.getWeekNumber();o!=n&&(i.push(s),n=o)}t.fontSize=18,t.strokeWidth=.8,t.textStroke="#000",t.textStrokeWidth=0,t.opacity=.03;for(var r=0;r<i.length-1;r++){t.bgfill="#555",t.textFill="#fff";timebands.addBox(this.top,this.cellWidth*(i[r]+5),this.headerHeight,2*this.cellWidth,this.nextYOffset-this.headerHeight,"",t,"")}}};var timebands={REVISION:"0.0.1"};timebands.dateDiffInDays=function(t,e){var i=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()),n=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());return Math.floor((n-i)/864e5)},Date.prototype.getWeekNumber=function(){var t=new Date(+this);return t.setHours(0,0,0),t.setDate(t.getDate()+4-(t.getDay()||7)),Math.ceil(((t-new Date(t.getFullYear(),0,1))/864e5+1)/7)},timebands.createLinearGradient=function(t,e,i,n,s){var a=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");return a.setAttribute("id",t),a.setAttribute("x1",e),a.setAttribute("y1",i),a.setAttribute("x2",n),a.setAttribute("y2",s),a},timebands.createStop=function(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg","stop");return i.setAttribute("offset",t),i.setAttribute("style",e),i},timebands.addBox=function(t,e,i,n,s,a,o,r,d){var h=document.createElementNS("http://www.w3.org/2000/svg","g");h.setAttribute("transform","translate("+e+","+i+")");var l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.style.fill=o.bgfill,l.style.stroke="black",l.style.originalStroke=l.style.stroke,l.setAttribute("x",0),l.setAttribute("y",0),l.setAttribute("width",n),l.setAttribute("height",s),l.setAttribute("rx",o.rx),l.setAttribute("ry",o.ry),l.style.strokeWidth=o.strokeWidth,l.style.originalStrokeWidth=l.style.strokeWidth,l.style.opacity=o.opacity;var c=document.createElementNS("http://www.w3.org/2000/svg","text");if(c.setAttribute("x",5),c.setAttribute("transform","scale(1,1)"),c.style.fontfamily="Helvetica",c.setAttribute("y",s-3),c.setAttribute("font-size",o.fontSize),h.setAttribute("alignment-baseline","baseline"),c.textContent=a,h.appendChild(l),h.appendChild(c),void 0!==r){var u=document.createElementNS("http://www.w3.org/2000/svg","title");u.textContent=r,h.appendChild(u)}return t.hasChildNodes()&&void 0!==t.children&&void 0===d?t.insertBefore(h,t.children[0]):t.appendChild(h),h},timebands.init=function(t,e,i,n,s){var a=new Date(i,n-1,1);t.setAttribute("style","font-family: Helvetica, Arial;-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;");var o=new TimeBand(t,i,n-1,s);o.addHeader();var r=7,d=30,h=new TextBoxStyle;h.fontSize=20,h.rx=3,h.ry=3,h.bgfill="#fff";var l=new TimeBandsParser;l.parse(e.innerHTML);for(var c=0;c<l.bandSections.length;c++){var u=l.bandSections[c];new Band(o,r),u.name.startsWith("!")?(h.section=!0,b=new Band(o,d,u.name.substr(1))):(b=new Band(o,d,u.name),u.band=b);for(var f=0;f<u.entries.length;f++){h.section&&(h.bgfill=f%2==0?"url(#grad1)":"url(#grad2)");var g=u.entries[f];h.bgfill=g.color;var m=g.getIntervalRelativeToDate(a);b.add(m[0],m[1]+1,g.name,h)}}o.addOverlay();var v=new BandEntry("",new Date,new Date);h.strokeWidth=.2,h.textStroke="#000",h.textStrokeWidth=0,h.opacity=.1,h.bgfill="red";var p=v.getIntervalRelativeToDate(a);timebands.addBox(o.top,o.cellWidth*p[0],o.headerHeight,1*o.cellWidth,o.nextYOffset-o.headerHeight,"",h,"",!0);o.view.scalableElements=o.scalableElements},timebands.create=function(t,e,i,n,s){svg=document.getElementById(t),defs=document.getElementById(e),timebands.init(svg,defs,i,n,s),svg.addEventListener("load",function(){timebands.init(svg,defs,i,n,s)},!1)};var BandEntry=function(t,e,i){this.name=t,this.from=e,this.to=i,this.getIntervalRelativeToDate=function(t){var n=timebands.dateDiffInDays(t,e),s=timebands.dateDiffInDays(t,i);return[n,s]}},BandSection=function(t){this.name=t,this.entries=[],this.toString=function(){return"BandSection["+t+"]: "+this.entries.length+" + entries"},this.addEntry=function(t){console.log("Added entry: "+t),this.entries.push(t)}},TimeParser=function(t){this.implicitYear=t};TimeParser.prototype={parseInterval:function(t){var e=t.split("-");if(2!=e.length)throw"The date interval ["+t+"] did not contain exactly one hyphen";var i=this.parseTime(e[0]),n=this.parseTime(e[1]);return[i,n]},parseTime:function(t){t=t.trim();var e,i=t.split("/");if(2==i.length)e=new Date(this.implicitYear,i[1]-1,i[0]);else{if(3!=i.length)throw"The date ["+t+"] did not contain one or two /-es";var n=i[2];100>n&&(n=2e3+parseInt(n)),e=new Date(n,i[1]-1,i[0])}return console.log("Parsed date: "+e),e}};var TimeBandsParser=function(){this.bandSections=[],this.timeParser=new TimeParser(2015)};TimeBandsParser.prototype={addBandSection:function(t){void 0!==t&&(this.bandSections.push(t),console.log("New section:"+t.toString()))},parseEntry:function(t){var e,i=/(.*)color\:(\S+)/,n="#fafafa";null!==(e=i.exec(t))&&(console.log("COLOR: "+e[1]),n=e[2],t=e[1],console.log("new name: "+t));var s=t.split(":");if(2!=s.length)throw"The entry ["+t+"] did not contain exactly one colon";var a=this.timeParser.parseInterval(s[0]),o=s[1],r=new BandEntry(o,a[0],a[1]);return r.color=n,r},parse:function(t){for(var e=t.match(/[^\r\n]+/g),i=void 0,n=0;n<e.length;n++)if(n<e.length-1&&e[n+1].startsWith("---"))i=new BandSection(e[n]),i.name.startsWith("-")||this.addBandSection(i),n++;else{if(console.log(n+" "+e[n]),void 0===i)throw"When parsing ["+e[n]+"] no section was defined";var s=this.parseEntry(e[n]);i.addEntry(s)}}};
//# sourceMappingURL=timebands-dev.min.js.map